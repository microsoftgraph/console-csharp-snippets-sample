---
page_type: sample
products:
- ms-graph
languages:
- csharp
description: "Это консольное приложение Windows демонстрирует выполнение различных операций при помощи клиентской библиотеки Microsoft Graph с разрешениями приложения и делегированными разрешениями. В этом примере для проверки подлинности в конечной точке Azure AD версии 2.0, используется библиотека проверки подлинности Майкрософт (MSAL)."
extensions:
  contentType: samples
  technologies:
  - Microsoft Graph 
  - Microsoft identity platform
  services:
  - Microsoft identity platform
  createdDate: 9/8/2017 1:33:44 PM
---
# Консольное приложение фрагментов Microsoft Graph C#

## Содержание

* [Введение](#introduction)
* [Предварительные требования](#prerequisites)
* [Регистрация ** ** приложения](#Register-the-delegated-permissions-application ) делегированных разрешений
* [Регистрация ** ** приложения](#Register-the-application-permissions-application ) разрешений приложения
* [Сборка и запуск примера](#build-and-run-the-sample)
* [Вопросы и комментарии](#questions-and-comments)
* [Участие](#contributing)
* [Дополнительные ресурсы](#additional-resources)

## Введение

В этом примере представлены фрагменты кода, использующие Microsoft Graph для отправки электронной почты, управления группами и выполнения других стандартных задач из консольного приложения Windows. Для работы с данными, возвращаемыми Microsoft Graph, используется [клиентский пакет SDK .NET Microsoft Graph](https://github.com/microsoftgraph/msgraph-sdk-dotnet).

Для проверки подлинности в этом примере используется библиотека Microsoft Authentication Library (MSAL). В примере показаны как делегированные разрешения, так и разрешения приложений.

**Делегированные разрешения** используются в приложениях, предусматривающих вход пользователя. Для таких приложений пользователь или администратор соглашается предоставить запрашиваемые разрешения. Приложение получает разрешение действовать от имени вошедшего пользователя, вызывая Microsoft Graph. Некоторые делегированные разрешения могут предоставлять пользователи, не являющиеся администраторами. Однако для разрешений высокого уровня требуется согласие администратора. Это приложение содержит операции, связанные с группами, требующие согласия администратора, а соответствующие разрешения, необходимые для их выполнения комментируются по умолчанию.

**Разрешения приложений** используются приложениями, которые запускаются без пользователей; Этот тип разрешения используется для приложений, которые запускаются в качестве фоновых служб или управляющих программ, и не будут использовать или требовать согласия пользователя. Для таких разрешений согласие предоставляет только администратор клиента. Важно понимать, что вы даете множество полномочий этому приложению, предоставляя ему согласие администратора. Например, если запустить этот пример в **AppMode** по отношению к клиенту, нужно будет создать группу, добавить и удалить участников группы, а затем удалить группу.

Чтобы использовать оба типа разрешений, вам потребуется создать и настроить два приложения в [центре администрирования Azure Active Directory](https://aad.portal.azure.com)— один для **делегированных разрешений** а другой — для **разрешений приложений**. Образец структурирован так, чтобы вы могли настроить только одно приложение, если вы хотите использовать только один тип разрешений. Используйте класс **UserMode**, если вы заинтересованы только в **делегированных разрешениях** и класс **AppMode**, если вы заинтересованы только в **разрешениях приложений**.

Дополнительные сведения про типы разрешений см. в [Разрешения приложения, делегированные разрешения и действующие разрешения](https://docs.microsoft.com/en-us/graph/permissions-reference#delegated-permissions-application-permissions-and-effective-permissions). Дополнительные сведения о **разрешениях приложений** см. в [Получение доступа без пользователя](https://docs.microsoft.com/en-us/graph/auth-v2-service).

## Предварительные требования

Для этого примера требуются следующие компоненты:

* [Visual Studio](https://www.visualstudio.com/en-us/downloads)

* [Учетная запись Office 365 для бизнеса](https://msdn.microsoft.com/en-us/office/office365/howto/setup-development-environment#bk_Office365Account). Для выполнения административных операций требуется учетная запись администратора Office 365. Вы можете подписаться на [план Office 365 для разработчиков](https://msdn.microsoft.com/en-us/office/office365/howto/setup-development-environment#bk_Office365Account), который включает ресурсы, необходимые для создания приложений.

## Регистрация приложения

Здесь приведены примеры, которые используют делегированные разрешения и разрешения приложений, поэтому вам потребуется зарегистрировать приложение отдельно для каждого сценария.

<a name="Register-the-delegated-permissions-application"></a>
### Регистрация приложения **делегированных разрешений**

1. Перейдите в [центр администрирования Azure Active Directory](https://aad.portal.azure.com). Войдите с помощью **личной учетной записи** (т. е. учетной записи Майкрософт) или **рабочей или учебной учетной записи**.

2. Выберите **Azure Active Directory** на панели навигации слева, затем выберите **Регистрация приложения (предварительная версия)** в разделе **Управление**.

3. Выберите **Новая регистрация**. На странице **Регистрация приложения** задайте необходимые значения следующим образом:

    * Задайте **Имя** для `примера консольных фрагментов (делегированных разрешений)`.
    * Установите **Поддерживаемые типы учетных записей** в **Учетные записи в любом каталоге организации и личных учетных записях Microsoft**.
    * Оставьте поле **URI перенаправления** пустым.
	** Выберите **Регистрация**.

4. На странице **примера консольных фрагментов (делегированных разрешений)** скопируйте значения **Идентификатора приложения (клиента)** и **Идентификатора каталога (клиента)**. Сохраните эти два значения, так как они понадобятся позже.

5. Выберите ссылку **добавить URI перенаправления**. На странице **URI перенаправления** найдите раздел **Предлагаемые URI перенаправления для общедоступных клиентов (мобильные, настольные)**. Выберите URI которые начинается с `msal` **и** URI **urn:ietf:wg:oauth:2.0:oob**.

6. Откройте образец решения в Visual Studio и откройте файл **Constants.cs**. Измените строку **клиента** на значение **идентификатора каталога (клиента)**, которое вы скопировали ранее. Измените строку**ClientIdForUserAuthn** на значение **Идентификатор приложения (клиента)**.

<a name="Register-the-application-permissions-application"></a>
### Регистрация приложения **разрешений приложения**

1. Перейдите в [центр администрирования Azure Active Directory](https://aad.portal.azure.com). Войдите с помощью **рабочей или учебной учетной записи**.

2. Выберите **Azure Active Directory** на панели навигации слева, затем выберите **Регистрация приложения (предварительная версия)** в разделе **Управление**.

3. Выберите **Новая регистрация**. На странице **Регистрация приложения** задайте необходимые значения следующим образом:

    * Задайте **Имя** для `примера консольных фрагментов (разрешений приложения)`.
    * Задайте для параметра **Поддерживаемые типы учетных записей** значение **Учетные записи в любом каталоге организации**.
    * Оставьте поле **URI перенаправления** пустым.
    * Нажмите кнопку **Зарегистрировать**.

4. На странице **примера консольных фрагментов (разрешений приложения)** скопируйте значения **Идентификатора приложения (клиента)** и **Идентификатора каталога (клиента)**. Они понадобятся вам на шаге 7.

5. Выберите **Сертификаты и секреты** в разделе **Управление**. Нажмите кнопку **Новый секрет клиента**. Введите значение в поле **Описание**, выберите любую опцию **Срок действия** и нажмите **Добавить**.

6. Скопируйте секретное значение клиента перед тем, как покинуть страницу. Оно понадобится вам на следующем шаге.

7. Откройте образец решения в Visual Studio и откройте файл **Constants.cs**. Измените строку **клиента** на значение **идентификатора каталога (клиента)**, которое вы скопировали ранее. Аналогичным образом измените строку **ClientIdForAppAuthn** на **значение идентификатора приложения (клиента)** и измените строку **ClientSecret** на секретное значение клиента.

8. Вернитесь в центр управления Azure Active Directory. Выберите **разрешения API**, а затем выберите **Добавить разрешение**. На появившейся панели выберите **Microsoft Graph**, а затем выберите **Права доступа к приложению**. 

9. Используйте окно поиска **Выбор разрешений** для поиска следующих разрешений: Directory.Read.All, Group.ReadWrite.All, Mail.Read, Mail.ReadWrite, и User.Read.All. Установите флажок для каждого отображаемого разрешения (обратите внимание, что разрешения скрываются из списка после их выбора). Нажмите кнопку **добавить разрешения** в нижней части панели.

10. Нажмите кнопку **предоставить согласие администратора для \[имя клиента]**. В появившемся диалоговом окне нажмите кнопку **да**, чтобы подтвердить это.

## Сборка и запуск примера

1. Откройте пример решения в Visual Studio.
2. Нажмите клавишу F5 для сборки и запуска примера. Это восстановит зависимости пакета NuGet и откроет консольное приложение.
3. Выберите режим пользователя, чтобы запустить приложение только с **делегированными разрешениями**. Выберите режим приложения, чтобы запустить приложение только с **разрешениями приложений**. Чтобы использовать оба типа разрешений, выберите оба ражима.
4. При запуске пользовательского режима вам понадобится выполнить вход с помощью учетной записи в клиенте Office 365 и подтвердить разрешения, запрашиваемые приложением. Если вы хотите выполнить операции, связанные с группами, в классе **UserMode**, раскомментируйте метод **GetDetailsForGroups** в файле UserMode.cs и области **Group.Read.All** в файле AuthenticationHelper.cs. После внесения этих изменений только администратор сможет входить в систему и предоставлять согласие. В противном случае вы можете войти в систему и предоставить согласие, не используя учетную запись администратора.
5. При запуске режима приложения, приложение начинает выполнять ряд распространенных задач, связанных с группами, которые может выполнить только администратор. После проверки приложения на выполнение этих операций, вам не потребуется выполнять вход и предоставлять согласие.

## Вопросы и комментарии

Мы будем рады получить ваши отзывы об API консольного приложения Microsoft Graph. Вы можете отправлять нам свои вопросы и предложения с помощью вкладки [Проблемы](https://github.com/microsoftgraph/console-csharp-snippets-sample/issues) этого репозитория.

Общие вопросы о разработке решений для Microsoft Graph следует задавать на сайте [Stack Overflow](https://stackoverflow.com/questions/tagged/microsoftgraph). Обязательно помечайте свои вопросы и комментарии тегом \[microsoftgraph].

## Участие

Если вы хотите добавить код в этот пример, просмотрите статью [CONTRIBUTING.MD](/CONTRIBUTING.md).

Этот проект соответствует [Правилам поведения разработчиков открытого кода Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения см. в разделе [вопросов и ответов о правилах поведения](https://opensource.microsoft.com/codeofconduct/faq/). Если у вас возникли вопросы или замечания, напишите нам по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).
  
## Дополнительные ресурсы

* [Получение доступа без пользователя](https://docs.microsoft.com/en-us/graph/auth-v2-service)
* [Разрешения приложения, делегированные разрешения и действующие разрешения](https://docs.microsoft.com/en-us/graph/permissions-reference#delegated-permissions-application-permissions-and-effective-permissions)
* [Microsoft Graph](https://developer.microsoft.com/en-us/graph)

## Авторские права

(c) Корпорация Майкрософт (Microsoft Corporation), 2017. Все права защищены.
